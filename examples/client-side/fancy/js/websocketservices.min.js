/**
* Copyright (c) 2013, Ken Anderson <caffeinatedrat at gmail dot com>
* All rights reserved.
* Redistribution and use in source and binary forms, with or without
* modification, are permitted provided that the following conditions are met:
*
*     * Redistributions of source code must retain the above copyright
*       notice, this list of conditions and the following disclaimer.
*     * Redistributions in binary form must reproduce the above copyright
*       notice, this list of conditions and the following disclaimer in the
*       documentation and/or other materials provided with the distribution.
*
* THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY
* EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
* WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
* DISCLAIMED. IN NO EVENT SHALL THE AUTHOR AND CONTRIBUTORS BE LIABLE FOR ANY
* DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
* (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
* LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
* ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
* (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
* SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/

/*
* -----------------------------------------------------------------
* Required Libraries:
* 1) Jquery.js
* -----------------------------------------------------------------
*/

/*
* -----------------------------------------------------------------
* Change Log
* Revision 3 (3/9/13)
* 1) Fixed an issue with the cross-origin property being set for dataurl images.
* 2) An image is now preloaded for the face canvases until the remote images load.
* Revision 3 (3/14/13)
* 1) Fixed some more issues with CORS
* 2) Fixed an issue where the default skin was not loading when a remote skin cannot be loaded.
* -----------------------------------------------------------------
*/

var CaffeinatedRat=CaffeinatedRat||{};CaffeinatedRat.Minecraft=CaffeinatedRat.Minecraft||{};
CaffeinatedRat.Minecraft.WebSocketServices=function(a){CaffeinatedRat.Minecraft.WebSocketServices.VERSION="1.1.7";CaffeinatedRat.Minecraft.WebSocketServices.REVISION="4";console.log("CaffeinatedRat.Minecraft.WebSocketServices.Version: "+CaffeinatedRat.Minecraft.WebSocketServices.VERSION+"-R."+CaffeinatedRat.Minecraft.WebSocketServices.REVISION);this._onlineTimerPID=this._pingTimerPID=0;this._images=[];this._defaultSkin=null;this._preloadFaceDataUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAIAAABLbSncAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAadEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjEwMPRyoQAAAKdJREFUGFclir0ORUAQhec1RITdxE8kPAibrRVka9EoblRbaQgFCbKUntQ91/2KmTnfHOKcu67LGHMcx7Is27YRAf0XCIIgTdMkSTzPQ+n32LbtPM/7vo0x13X1fR+GIQ3DsCwL5jzPWuvjOD4vBPs8T57n0zTB4kBEj9q2HcdxXdfsZd/3ruvKsqS6rpumiaIIAcRxDFNVFUkphRB4+L4PC5RSRVF8AaVKRHcXMKlqAAAAAElFTkSuQmCC";
var c=0;this._templatePluginList=this._templateOfflinePlayerList=this._templateWhiteList=this._templateWho=this._pluginInfoCallback=this._offlineInfoCallback=this._whiteListInfoCallback=this._playerInfoCallback=this._serverInfoCallback=this._pingserverTimeCallback=this._pingDisconnectedCallback=this._pingConnectedCallback=null;a=a||{};a.websocketCheck=void 0===a.websocketCheck?!0:a.websocketCheck;if(!("WebSocket"in window)&&a.websocketCheck)throw new CaffeinatedRat.Minecraft.WebSocketServices.NotSupportedException("constructor");
if(void 0!==a.websocketAddress)this._websocketAddress=a.websocketAddress;else throw new CaffeinatedRat.Minecraft.WebSocketServices.InvalidAddressException("constructor");this._pingInterval=void 0!==a.pingInterval?a.pingInterval:15E3;this._onlineInterval=void 0!==a.onlineInterval?a.onlineInterval:15E3;this._debug=void 0!==a.debug?a.debug:!1;this._imageServerURL=void 0!==a.imageServerURL?a.imageServerURL:"http://s3.amazonaws.com/MinecraftSkins/";this._forceDefaultSkin=void 0!==a.forceDefaultSkin?a.forceDefaultSkin:
!1;this._defaultSkin=void 0!==a.defaultSkin?a.defaultSkin:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAgCAMAAACVQ462AAAABGdBTUEAALGPC/xhBQAAAwBQTFRFAAAAHxALIxcJJBgIJBgKJhgLJhoKJxsLJhoMKBsKKBsLKBoNKBwLKRwMKh0NKx4NKx4OLR0OLB4OLx8PLB4RLyANLSAQLyIRMiMQMyQRNCUSOigUPyoVKCgoPz8/JiFbMChyAFtbAGBgAGhoAH9/Qh0KQSEMRSIOQioSUigmUTElYkMvbUMqb0UsakAwdUcvdEgvek4za2trOjGJUj2JRjqlVknMAJmZAJ6eAKioAK+vAMzMikw9gFM0hFIxhlM0gVM5g1U7h1U7h1g6ilk7iFo5j14+kF5Dll9All9BmmNEnGNFnGNGmmRKnGdIn2hJnGlMnWpPlm9bnHJcompHrHZaqn1ms3titXtnrYBttIRttolsvohst4Jyu4lyvYtyvY5yvY50xpaA////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPSUN6AAAAQB0Uk5T////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AFP3ByUAAAAYdEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My4zNqnn4iUAAAKjSURBVEhLpZSLVtNAEIYLpSlLSUITLCBaGhNBQRM01M2mSCoXNUURIkZFxQvv/wz6724Wij2HCM7J6UyS/b+dmZ208rsww6jiqo4FhannZb5yDqjaNgDVwE/8JAmCMqF6fwGwbU0CKjD/+oAq9jcM27gxAFpNQxU3Bwi9Ajy8fgmGZuvaGAcIuwFA12CGce1jJESr6/Ot1i3Tnq5qptFqzet1jRA1F2XHWQFAs3RzwTTNhQd3rOkFU7c0DijmohRg1TR9ZmpCN7/8+PX954fb+sTUjK7VLKOYi1IAaTQtUrfm8pP88/vTw8M5q06sZoOouSgHEDI5vrO/eHK28el04yxf3N8ZnyQooZiLfwA0arNb6d6bj998/+vx8710a7bW4E2Uc1EKsEhz7WiQBK9eL29urrzsB8ngaK1JLDUXpYAkGSQH6e7640fL91dWXjxZ33138PZggA+Sz0WQlAL4gmewuzC1uCenqXevMPWc9XrMX/VXh6Hicx4ByHEeAfRg/wtgSMAvz+CKEkYAnc5SpwuD4z70PM+hUf+4348ixF7EGItjxmQcCx/Dzv/SOkuXAF3PdT3GIujjGLELNYwxhF7M4oi//wsgdlYZdMXCmEUUSsSu0OOBACMoBTiu62BdRPEjYxozXFyIpK7IAE0IYa7jOBRqGlOK0BFq3Kdpup3DthFwP9QDlBCGKEECoHEBEDLAXHAQMQnI8jwFYRQw3AMOQAJoOADoAVcDAh0HZAKQZUMZdC43kdeqAPwUBEsC+M4cIEq5KEEBCl90mR8CVR3nxwCdBBS9OAe020UGnXb7KcxzPY9SXoEEIBZtgE7UDgBKyLMhgBS2YdzjMJb4XHRDAPiQhSGjNOxKQIZTgC8BiMECgarxprjjO0OXiV4MAf4A/x0nbcyiS5EAAAAASUVORK5CYII=";
this._imageSmoothing=void 0!==a.imageSmoothing?a.imageSmoothing:!0;this.getCanvasId=function(){return c++};$(".wssMinecraftPlayerList").hide();$(".wssMinecraftWhiteList").hide();$(".wssMinecraftOfflineList").hide();$(".wssMinecraftPluginList").hide()};CaffeinatedRat.Minecraft.WebSocketServices.prototype.getImage=function(a){if(void 0!==this._images)return this._images[a]};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.mapToTemplate=function(a,c,b,e){if(null!=a){var d=a.find(".wssListItemTemplate");if(0<d.length)if(0<b.length){c.find(".wssListItemTemplate").remove();c.find(".wssEmptyListTemplate").remove();a=d.clone();d=a.children(":first").detach();a.appendTo(c);for(i=0;i<b.length;i++)if(void 0!==e)this[e](b[i],a,d);else console.log("CaffeinatedRat.Minecraft.WebSocketServices.mapToTemplate: No mapping function was defined."),c.text("No mapping function was defined.")}else c.find(".wssListItemTemplate").remove(),
c.find(".wssEmptyListTemplate").remove(),b=a.find(".wssEmptyListTemplate").clone(),0<b.length?b.appendTo(c):c.text("No empty-list item template was defined.");else c.find(".wssEmptyListTemplate").remove(),c.text("No list item template was defined.")}else c.find(".wssEmptyListTemplate").remove(),c.text("No list item template was defined.")};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.drawPlayersFace=function(a,c){var b=this;if(void 0===b._images[c]){var e=new Image;e.onload=function(){var d=document.getElementById(a);if(void 0!==d&&d){var e=d.getContext("2d");void 0!==e&&(e.mozImageSmoothingEnabled=b._imageSmoothing,e.webkitImageSmoothingEnabled=b._imageSmoothing,e.drawImage(this,0,0,d.width,d.height))}b._images[c]=this;d=new Image;d.crossOrigin="";d.setAttribute("data-canvasId",a);d.onload=function(){var a=document.getElementById(this.getAttribute("data-canvasId"));
if(void 0!==a&&a){var d=a.getContext("2d");void 0!==d&&(d.mozImageSmoothingEnabled=b._imageSmoothing,d.webkitImageSmoothingEnabled=b._imageSmoothing,d.drawImage(this,8,8,8,8,0,0,a.width,a.height))}b._images[c]=this};d.onerror=function(){var a=document.getElementById(this.getAttribute("data-canvasId")),d=new Image;d.onload=function(){if(void 0!==a&&a){var d=a.getContext("2d");void 0!==d&&(d.mozImageSmoothingEnabled=b._imageSmoothing,d.webkitImageSmoothingEnabled=b._imageSmoothing,d.drawImage(this,
8,8,8,8,0,0,a.width,a.height))}b._images[c]=this};d.src=b._defaultSkin};d.src=b._forceDefaultSkin?b._defaultSkin:b._imageServerURL+c+".png"};e.src=b._preloadFaceDataUrl}else{var e=this._images[c],d=document.getElementById(a);if(void 0!==d){var g=d.getContext("2d");void 0!==g&&(g.mozImageSmoothingEnabled=b._imageSmoothing,g.webkitImageSmoothingEnabled=b._imageSmoothing,g.drawImage(e,8,8,8,8,0,0,d.width,d.height))}}};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.playerInfoMapping=function(a,c,b){var e="Online: Now";void 0===a.onlineTime?a.isOnline||(e="Last Played: "+a.lastPlayed+""):e="Online: "+a.onlineTime+"";b=b.clone();a.isOperator?b.find(".wssPlayerIsNotOperator").remove():b.find(".wssPlayerIsOperator").remove();var d="canvas"+this.getCanvasId()+a.name,g="normal";void 0!==a.environment&&(g=a.environment.replace("_","").toLowerCase());b.html(b.html().replace(/#wssPlayerFace#/g,'<canvas class="playersFace" id="'+
d+'"></canvas>'));b.html(b.html().replace(/#wssPlayerIsOperator#/g,a.isOperator));b.html(b.html().replace(/#wssPlayerName#/g,a.name));b.html(b.html().replace(/#wssPlayerEnvironment#/g,g));b.html(b.html().replace(/#wssPlayerOnlineTime#/g,e));b.appendTo(c);this.drawPlayersFace(d,a.name)};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.pluginInfoMapping=function(a,c,b){b=b.clone();b.html(b.html().replace(/#wssPluginName#/g,a.name));b.html(b.html().replace(/#wssPluginVersion#/g,a.version));b.html(b.html().replace(/#wssPluginAuthor#/g,a.author));b.html(b.html().replace(/#wssPluginDescription#/g,a.description));b.appendTo(c)};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.ping=function(a){a=a||{};void 0!==a.connectedCallback&&(this._pingConnectedCallback=a.connectedCallback);void 0!==a.disconnectedCallback&&(this._pingDisconnectedCallback=a.disconnectedCallback);void 0!==a.serverTimeCallback&&(this._pingserverTimeCallback=a.serverTimeCallback);void 0!==a.updateTime&&(this._pingInterval=a.updateTime);var c=!1,b=new WebSocket(this._websocketAddress),e=this;b.onopen=function(){c=!0;b.send("ping")};b.onmessage=function(a){e._debug&&
console.log(a.data);a=jQuery.parseJSON(a.data);"SUCCESSFUL"==a.Status&&(e._pingserverTimeCallback&&e._pingserverTimeCallback(a.serverTime),a.wssVersion!=CaffeinatedRat.Minecraft.WebSocketServices.VERSION&&console.log("[WARNING] CaffeinatedRat.Minecraft.WebSocketServices:  Version mismatch (Plugin: "+a.wssVersion+", Client: "+CaffeinatedRat.Minecraft.WebSocketServices.VERSION+")"))};b.onclose=function(){c?e._pingConnectedCallback&&e._pingConnectedCallback():e._pingDisconnectedCallback&&e._pingDisconnectedCallback();
e._pingTimerPID=setTimeout(function(){e.ping()},e._pingInterval)};b.onerror=function(a){console.log("WebSocket Error "+a)}};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.getServerInfo=function(a){a=a||{};void 0!==a.callback&&(this._serverInfoCallback=a.callback);var c=new WebSocket(this._websocketAddress),b=this;c.onopen=function(){c.send("info")};c.onmessage=function(a){if(void 0!==a){b._debug&&console.log(a.data);try{var d=jQuery.parseJSON(a.data);b._serverInfoCallback&&b._serverInfoCallback(d);"SUCCESSFUL"==d.Status&&($(".wssMinecraftServerName").text(d.serverName),$(".wssMinecraftServerType").text(d.name),$(".wssMinecraftVersion").text(d.version),
$(".wssMinecraftBukkitVersion").text(d.bukkitVersion),$(".wssMinecraftMOTD").text(d.motd.replace(/\u00A7/g,"")),$(".wssMinecraftWorldType").text(d.worldType),$(".wssMinecraftGameMode").text(d.gameMode),$(".wssMinecraftIsWhiteListed").text(d.isWhiteListed),$(".wssMinecraftAllowsNether").text(d.allowsNether),$(".wssMinecraftAllowsEnd").text(d.allowsEnd),$(".wssMinecraftAllowsFlight").text(d.allowsFlight),$(".wssMinecraftPort").text(d.port),$(".wssMinecraftIPAddress").text(d.ipAddress),$(".wssMinecraftTime").text(13E3<=
d.serverTime%23E3?"Night":"Day"))}catch(c){console.log(c)}}};c.onerror=function(a){console.log("WebSocket Error "+a)}};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.getPlayerInfo=function(a){a=a||{};void 0!==a.updateTime&&(this._onlineInterval=a.updateTime);void 0!==a.callback&&(this._playerInfoCallback=a.callback);var c=new WebSocket(this._websocketAddress),b=this;c.onopen=function(){c.send("who")};c.onmessage=function(a){if(void 0!==a){b._debug&&console.log(a.data);try{var d=jQuery.parseJSON(a.data);b._playerInfoCallback&&b._playerInfoCallback(d);if("SUCCESSFUL"===d.Status){$(".wssMinecraftMaxNumberOfPlayers").text(d.MaxPlayers);
$(".wssMinecraftTotalPlayersOnline").text(d.Players.length);var c=$(".wssMinecraftPlayerList");0<c.length&&null==b._templateWho&&(b._templateWho=c.clone());b.mapToTemplate(b._templateWho,c,d.Players,"playerInfoMapping");$(".wssMinecraftPlayerList").show()}}catch(f){console.log(f)}}};c.onclose=function(){0<b._onlineInterval&&(b._onlineTimerPID=setTimeout(function(){b.getPlayerInfo()},b._onlineInterval))};c.onerror=function(a){console.log("WebSocket Error "+a)}};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.getWhiteListing=function(a){a=a||{};void 0!==a.callback&&(this._whiteListInfoCallback=a.callback);var c=new WebSocket(this._websocketAddress),b=this;c.onopen=function(){c.send("whitelist")};c.onmessage=function(a){if(void 0!==a){b._debug&&console.log(a.data);try{var d=jQuery.parseJSON(a.data);b._whiteListInfoCallback&&b._whiteListInfoCallback(d);if("SUCCESSFUL"==d.Status){$(".wssTotalWhitelistedPlayers").text(d.Whitelist.length);var c=$(".wssMinecraftWhiteList");
0<c.length&&null==b._templateWhiteList&&(b._templateWhiteList=c.clone());b.mapToTemplate(b._templateWhiteList,c,d.Whitelist,"playerInfoMapping");$(".wssMinecraftWhiteList").show()}}catch(f){console.log(f)}}};c.onerror=function(a){console.log("WebSocket Error "+a)}};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.getOfflinePlayers=function(a){a=a||{};void 0!==a.callback&&(this._offlineInfoCallback=a.callback);var c=new WebSocket(this._websocketAddress),b=this;c.onopen=function(){c.send("offlinePlayers")};c.onmessage=function(a){if(void 0!==a){b._debug&&console.log(a.data);try{var d=jQuery.parseJSON(a.data);b._offlineInfoCallback&&b._offlineInfoCallback(d);if("SUCCESSFUL"==d.Status){$("#wssTotalOfflinePlayers").text(d.OfflinePlayers.length);var c=$(".wssMinecraftOfflineList");
0<c.length&&null==b._templateOfflinePlayerList&&(b._templateOfflinePlayerList=c.clone());b.mapToTemplate(b._templateOfflinePlayerList,c,d.OfflinePlayers,"playerInfoMapping");$(".wssMinecraftOfflineList").show()}}catch(f){console.log(f)}}};c.onerror=function(a){console.log("WebSocket Error "+a)}};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.getPluginInfo=function(a){a=a||{};void 0!==a.callback&&(this._pluginInfoCallback=a.callback);var c=new WebSocket(this._websocketAddress),b=this;c.onopen=function(){c.send("plugins")};c.onmessage=function(a){if(void 0!==a){b._debug&&console.log(a.data);try{var d=jQuery.parseJSON(a.data);b._pluginInfoCallback&&b._pluginInfoCallback(d);if("SUCCESSFUL"==d.Status){var c=$(".wssPluginList");0<c.length&&null==b._templatePluginList&&(b._templatePluginList=
c.clone());b.mapToTemplate(b._templatePluginList,c,d.Plugins,"pluginInfoMapping");$(".wssMinecraftPluginList").show()}}catch(f){console.log(f)}}};c.onerror=function(a){console.log("WebSocket Error "+a)}};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.callService=function(a,c){c=c||{};var b=new WebSocket(this._websocketAddress),e=this;b.onopen=function(){b.send(a)};b.onmessage=function(a){if(void 0!==a){e._debug&&console.log(a.data);try{var b=jQuery.parseJSON(a.data);c.callback&&c.callback(b)}catch(f){console.log(f)}}};b.onerror=function(a){console.log("WebSocket Error "+a)}};
CaffeinatedRat.Minecraft.WebSocketServices.Exception=function(a,c){var b="CaffeinatedRat.Minecraft.WebSocketServices"+(void 0!==a?"."+a:""),b=b+(": "+c);this.toString=function(){return b}};CaffeinatedRat.Minecraft.WebSocketServices.NotSupportedException=function(a){CaffeinatedRat.Minecraft.WebSocketServices.Exception.call(this,a,"Websockets are not supported by this browser.")};
CaffeinatedRat.Minecraft.WebSocketServices.InvalidAddressException=function(a){CaffeinatedRat.Minecraft.WebSocketServices.Exception.call(this,a,"No WebSocket address has been provided.")};