/**
* Copyright (c) 2013, Ken Anderson <caffeinatedrat at gmail dot com>
* All rights reserved.
* Redistribution and use in source and binary forms, with or without
* modification, are permitted provided that the following conditions are met:
*
*     * Redistributions of source code must retain the above copyright
*       notice, this list of conditions and the following disclaimer.
*     * Redistributions in binary form must reproduce the above copyright
*       notice, this list of conditions and the following disclaimer in the
*       documentation and/or other materials provided with the distribution.
*
* THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY
* EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
* WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
* DISCLAIMED. IN NO EVENT SHALL THE AUTHOR AND CONTRIBUTORS BE LIABLE FOR ANY
* DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
* (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
* LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
* ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
* (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
* SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/

/*
* -----------------------------------------------------------------
* Required Libraries:
* 1) Jquery.js
* -----------------------------------------------------------------
*/

/*
* -----------------------------------------------------------------
* Change Log
* Revision 3 (3/9/13)
* 1) Fixed an issue with the cross-origin property being set for dataurl images.
* 2) An image is now preloaded for the face canvases until the remote images load.
* Revision 4 (3/14/13)
* 1) Fixed some more issues with CORS
* 2) Fixed an issue where the default skin was not loading when a remote skin cannot be loaded.
* -----------------------------------------------------------------
*/
var CaffeinatedRat=CaffeinatedRat||{};CaffeinatedRat.Minecraft=CaffeinatedRat.Minecraft||{};
CaffeinatedRat.Minecraft.WebSocketServices=function(a){CaffeinatedRat.Minecraft.WebSocketServices.VERSION="1.1.8";CaffeinatedRat.Minecraft.WebSocketServices.REVISION="4";console.log("CaffeinatedRat.Minecraft.WebSocketServices.Version: "+CaffeinatedRat.Minecraft.WebSocketServices.VERSION+"-R."+CaffeinatedRat.Minecraft.WebSocketServices.REVISION);this._onlineTimerPID=this._pingTimerPID=0;this._images=[];this._defaultSkin=null;this._preloadFaceDataUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAIAAABLbSncAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAadEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjEwMPRyoQAAAKdJREFUGFclir0ORUAQhec1RITdxE8kPAibrRVka9EoblRbaQgFCbKUntQ91/2KmTnfHOKcu67LGHMcx7Is27YRAf0XCIIgTdMkSTzPQ+n32LbtPM/7vo0x13X1fR+GIQ3DsCwL5jzPWuvjOD4vBPs8T57n0zTB4kBEj9q2HcdxXdfsZd/3ruvKsqS6rpumiaIIAcRxDFNVFUkphRB4+L4PC5RSRVF8AaVKRHcXMKlqAAAAAElFTkSuQmCC";
var d=0;this._templatePluginList=this._templateOfflinePlayerList=this._templateWhiteList=this._templateWho=this._pluginInfoCallback=this._offlineInfoCallback=this._whiteListInfoCallback=this._playerInfoCallback=this._serverInfoCallback=this._pingserverTimeCallback=this._pingDisconnectedCallback=this._pingConnectedCallback=null;a=a||{};a.websocketCheck=void 0===a.websocketCheck?!0:a.websocketCheck;if(!("WebSocket"in window)&&a.websocketCheck)throw new CaffeinatedRat.Minecraft.WebSocketServices.NotSupportedException("constructor");
if(void 0!==a.websocketAddress)this._websocketAddress=a.websocketAddress;else throw new CaffeinatedRat.Minecraft.WebSocketServices.InvalidAddressException("constructor");this._pingInterval=void 0!==a.pingInterval?a.pingInterval:15E3;this._onlineInterval=void 0!==a.onlineInterval?a.onlineInterval:15E3;this._debug=void 0!==a.debug?a.debug:!1;this._imageServerURL=void 0!==a.imageServerURL?a.imageServerURL:"http://s3.amazonaws.com/MinecraftSkins/";this._forceDefaultSkin=void 0!==a.forceDefaultSkin?a.forceDefaultSkin:
!1;this._defaultSkin=void 0!==a.defaultSkin?a.defaultSkin:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAgCAMAAACVQ462AAAABGdBTUEAALGPC/xhBQAAAwBQTFRFAAAAHxALIxcJJBgIJBgKJhgLJhoKJxsLJhoMKBsKKBsLKBoNKBwLKRwMKh0NKx4NKx4OLR0OLB4OLx8PLB4RLyANLSAQLyIRMiMQMyQRNCUSOigUPyoVKCgoPz8/JiFbMChyAFtbAGBgAGhoAH9/Qh0KQSEMRSIOQioSUigmUTElYkMvbUMqb0UsakAwdUcvdEgvek4za2trOjGJUj2JRjqlVknMAJmZAJ6eAKioAK+vAMzMikw9gFM0hFIxhlM0gVM5g1U7h1U7h1g6ilk7iFo5j14+kF5Dll9All9BmmNEnGNFnGNGmmRKnGdIn2hJnGlMnWpPlm9bnHJcompHrHZaqn1ms3titXtnrYBttIRttolsvohst4Jyu4lyvYtyvY5yvY50xpaA////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPSUN6AAAAQB0Uk5T////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AFP3ByUAAAAYdEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My4zNqnn4iUAAAKjSURBVEhLpZSLVtNAEIYLpSlLSUITLCBaGhNBQRM01M2mSCoXNUURIkZFxQvv/wz6724Wij2HCM7J6UyS/b+dmZ208rsww6jiqo4FhannZb5yDqjaNgDVwE/8JAmCMqF6fwGwbU0CKjD/+oAq9jcM27gxAFpNQxU3Bwi9Ajy8fgmGZuvaGAcIuwFA12CGce1jJESr6/Ot1i3Tnq5qptFqzet1jRA1F2XHWQFAs3RzwTTNhQd3rOkFU7c0DijmohRg1TR9ZmpCN7/8+PX954fb+sTUjK7VLKOYi1IAaTQtUrfm8pP88/vTw8M5q06sZoOouSgHEDI5vrO/eHK28el04yxf3N8ZnyQooZiLfwA0arNb6d6bj998/+vx8710a7bW4E2Uc1EKsEhz7WiQBK9eL29urrzsB8ngaK1JLDUXpYAkGSQH6e7640fL91dWXjxZ33138PZggA+Sz0WQlAL4gmewuzC1uCenqXevMPWc9XrMX/VXh6Hicx4ByHEeAfRg/wtgSMAvz+CKEkYAnc5SpwuD4z70PM+hUf+4348ixF7EGItjxmQcCx/Dzv/SOkuXAF3PdT3GIujjGLELNYwxhF7M4oi//wsgdlYZdMXCmEUUSsSu0OOBACMoBTiu62BdRPEjYxozXFyIpK7IAE0IYa7jOBRqGlOK0BFq3Kdpup3DthFwP9QDlBCGKEECoHEBEDLAXHAQMQnI8jwFYRQw3AMOQAJoOADoAVcDAh0HZAKQZUMZdC43kdeqAPwUBEsC+M4cIEq5KEEBCl90mR8CVR3nxwCdBBS9OAe020UGnXb7KcxzPY9SXoEEIBZtgE7UDgBKyLMhgBS2YdzjMJb4XHRDAPiQhSGjNOxKQIZTgC8BiMECgarxprjjO0OXiV4MAf4A/x0nbcyiS5EAAAAASUVORK5CYII=";
this._imageSmoothing=void 0!==a.imageSmoothing?a.imageSmoothing:!0;this.getCanvasId=function(){return d++};$(".wssMinecraftPlayerList").hide();$(".wssMinecraftWhiteList").hide();$(".wssMinecraftOfflineList").hide();$(".wssMinecraftPluginList").hide()};CaffeinatedRat.Minecraft.WebSocketServices.prototype.getImage=function(a){if(void 0!==this._images)return this._images[a]};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.mapToTemplate=function(a,d,b,e){if(null!=a){var c=a.find(".wssListItemTemplate");if(0<c.length)if(0<b.length){d.find(".wssListItemTemplate").remove();d.find(".wssEmptyListTemplate").remove();a=c.clone();c=a.children(":first").detach();a.appendTo(d);for(i=0;i<b.length;i++)if(void 0!==e)this[e](b[i],a,c);else console.log("CaffeinatedRat.Minecraft.WebSocketServices.mapToTemplate: No mapping function was defined."),d.text("No mapping function was defined.")}else d.find(".wssListItemTemplate").remove(),
d.find(".wssEmptyListTemplate").remove(),b=a.find(".wssEmptyListTemplate").clone(),0<b.length?b.appendTo(d):d.text("No empty-list item template was defined.");else d.find(".wssEmptyListTemplate").remove(),d.text("No list item template was defined.")}else d.find(".wssEmptyListTemplate").remove(),d.text("No list item template was defined.")};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.drawPlayersFace=function(a,d){var b=this;if(void 0===b._images[d]){var e=new Image;e.onload=function(){var c=document.getElementById(a);if(void 0!==c&&c){var e=c.getContext("2d");void 0!==e&&(e.mozImageSmoothingEnabled=b._imageSmoothing,e.webkitImageSmoothingEnabled=b._imageSmoothing,e.drawImage(this,0,0,c.width,c.height))}b._images[d]=this;c=new Image;c.crossOrigin="";c.setAttribute("data-canvasId",a);c.onload=function(){var a=document.getElementById(this.getAttribute("data-canvasId"));
if(void 0!==a&&a){var c=a.getContext("2d");void 0!==c&&(c.mozImageSmoothingEnabled=b._imageSmoothing,c.webkitImageSmoothingEnabled=b._imageSmoothing,c.drawImage(this,8,8,8,8,0,0,a.width,a.height))}b._images[d]=this};c.onerror=function(){var a=document.getElementById(this.getAttribute("data-canvasId")),c=new Image;c.onload=function(){if(void 0!==a&&a){var c=a.getContext("2d");void 0!==c&&(c.mozImageSmoothingEnabled=b._imageSmoothing,c.webkitImageSmoothingEnabled=b._imageSmoothing,c.drawImage(this,
8,8,8,8,0,0,a.width,a.height))}b._images[d]=this};c.onerror=function(){var c=new Image;c.onload=function(){if(void 0!==a&&a){var c=a.getContext("2d");void 0!==c&&(c.mozImageSmoothingEnabled=b._imageSmoothing,c.webkitImageSmoothingEnabled=b._imageSmoothing,c.drawImage(this,8,8,8,8,0,0,a.width,a.height))}b._images[d]=this};c.src=b._defaultSkin};c.src=b._forceDefaultSkin?b._defaultSkin:b._imageServerURL+d+".png"};c.src=b._forceDefaultSkin?b._defaultSkin:b._imageServerURL+d+".png"};e.src=b._preloadFaceDataUrl}else{var e=
this._images[d],c=document.getElementById(a);if(void 0!==c){var g=c.getContext("2d");void 0!==g&&(g.mozImageSmoothingEnabled=b._imageSmoothing,g.webkitImageSmoothingEnabled=b._imageSmoothing,g.drawImage(e,8,8,8,8,0,0,c.width,c.height))}}};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.playerInfoMapping=function(a,d,b){var e="Online: Now";void 0===a.onlineTime?a.isOnline||(e="Last Played: "+a.lastPlayed+""):e="Online: "+a.onlineTime+"";b=b.clone();a.isOperator?b.find(".wssPlayerIsNotOperator").remove():b.find(".wssPlayerIsOperator").remove();var c="canvas"+this.getCanvasId()+a.name,g="normal";void 0!==a.environment&&(g=a.environment.replace("_","").toLowerCase());b.html(b.html().replace(/#wssPlayerFace#/g,'<canvas class="playersFace" id="'+
c+'"></canvas>'));b.html(b.html().replace(/#wssPlayerIsOperator#/g,a.isOperator));b.html(b.html().replace(/#wssPlayerName#/g,a.name));b.html(b.html().replace(/#wssPlayerEnvironment#/g,g));b.html(b.html().replace(/#wssPlayerOnlineTime#/g,e));b.appendTo(d);this.drawPlayersFace(c,a.name)};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.pluginInfoMapping=function(a,d,b){b=b.clone();b.html(b.html().replace(/#wssPluginName#/g,a.name));b.html(b.html().replace(/#wssPluginVersion#/g,a.version));b.html(b.html().replace(/#wssPluginAuthor#/g,a.author));b.html(b.html().replace(/#wssPluginDescription#/g,a.description));b.appendTo(d)};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.ping=function(a){a=a||{};void 0!==a.connectedCallback&&(this._pingConnectedCallback=a.connectedCallback);void 0!==a.disconnectedCallback&&(this._pingDisconnectedCallback=a.disconnectedCallback);void 0!==a.serverTimeCallback&&(this._pingserverTimeCallback=a.serverTimeCallback);void 0!==a.updateTime&&(this._pingInterval=a.updateTime);var d=!1,b=new WebSocket(this._websocketAddress),e=this;b.onopen=function(){d=!0;b.send("ping")};b.onmessage=function(a){e._debug&&
console.log(a.data);a=jQuery.parseJSON(a.data);"SUCCESSFUL"==a.Status&&(e._pingserverTimeCallback&&e._pingserverTimeCallback(a.serverTime),a.wssVersion!=CaffeinatedRat.Minecraft.WebSocketServices.VERSION&&console.log("[WARNING] CaffeinatedRat.Minecraft.WebSocketServices:  Version mismatch (Plugin: "+a.wssVersion+", Client: "+CaffeinatedRat.Minecraft.WebSocketServices.VERSION+")"))};b.onclose=function(){d?e._pingConnectedCallback&&e._pingConnectedCallback():e._pingDisconnectedCallback&&e._pingDisconnectedCallback();
e._pingTimerPID=setTimeout(function(){e.ping()},e._pingInterval)};b.onerror=function(a){console.log("WebSocket Error "+a)}};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.getServerInfo=function(a){a=a||{};void 0!==a.callback&&(this._serverInfoCallback=a.callback);var d=new WebSocket(this._websocketAddress),b=this;d.onopen=function(){d.send("info")};d.onmessage=function(a){if(void 0!==a){b._debug&&console.log(a.data);try{var c=jQuery.parseJSON(a.data);b._serverInfoCallback&&b._serverInfoCallback(c);"SUCCESSFUL"==c.Status&&($(".wssMinecraftServerName").text(c.serverName),$(".wssMinecraftServerType").text(c.name),$(".wssMinecraftVersion").text(c.version),
$(".wssMinecraftBukkitVersion").text(c.bukkitVersion),$(".wssMinecraftMOTD").text(c.motd.replace(/\u00A7/g,"")),$(".wssMinecraftWorldType").text(c.worldType),$(".wssMinecraftGameMode").text(c.gameMode),$(".wssMinecraftIsWhiteListed").text(c.isWhiteListed),$(".wssMinecraftAllowsNether").text(c.allowsNether),$(".wssMinecraftAllowsEnd").text(c.allowsEnd),$(".wssMinecraftAllowsFlight").text(c.allowsFlight),$(".wssMinecraftPort").text(c.port),$(".wssMinecraftIPAddress").text(c.ipAddress),$(".wssMinecraftTime").text(13E3<=
c.serverTime%23E3?"Night":"Day"))}catch(d){console.log(d)}}};d.onerror=function(a){console.log("WebSocket Error "+a)}};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.getPlayerInfo=function(a){a=a||{};void 0!==a.updateTime&&(this._onlineInterval=a.updateTime);void 0!==a.callback&&(this._playerInfoCallback=a.callback);var d=new WebSocket(this._websocketAddress),b=this;d.onopen=function(){d.send("who")};d.onmessage=function(a){if(void 0!==a){b._debug&&console.log(a.data);try{var c=jQuery.parseJSON(a.data);b._playerInfoCallback&&b._playerInfoCallback(c);if("SUCCESSFUL"===c.Status){$(".wssMinecraftMaxNumberOfPlayers").text(c.MaxPlayers);
$(".wssMinecraftTotalPlayersOnline").text(c.Players.length);var d=$(".wssMinecraftPlayerList");0<d.length&&null==b._templateWho&&(b._templateWho=d.clone());b.mapToTemplate(b._templateWho,d,c.Players,"playerInfoMapping");$(".wssMinecraftPlayerList").show()}}catch(f){console.log(f)}}};d.onclose=function(){0<b._onlineInterval&&(b._onlineTimerPID=setTimeout(function(){b.getPlayerInfo()},b._onlineInterval))};d.onerror=function(a){console.log("WebSocket Error "+a)}};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.getWhiteListing=function(a){a=a||{};void 0!==a.callback&&(this._whiteListInfoCallback=a.callback);var d=new WebSocket(this._websocketAddress),b=this;d.onopen=function(){d.send("whitelist")};d.onmessage=function(a){if(void 0!==a){b._debug&&console.log(a.data);try{var c=jQuery.parseJSON(a.data);b._whiteListInfoCallback&&b._whiteListInfoCallback(c);if("SUCCESSFUL"==c.Status){$(".wssTotalWhitelistedPlayers").text(c.Whitelist.length);var d=$(".wssMinecraftWhiteList");
0<d.length&&null==b._templateWhiteList&&(b._templateWhiteList=d.clone());b.mapToTemplate(b._templateWhiteList,d,c.Whitelist,"playerInfoMapping");$(".wssMinecraftWhiteList").show()}}catch(f){console.log(f)}}};d.onerror=function(a){console.log("WebSocket Error "+a)}};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.getOfflinePlayers=function(a){a=a||{};void 0!==a.callback&&(this._offlineInfoCallback=a.callback);var d=new WebSocket(this._websocketAddress),b=this;d.onopen=function(){d.send("offlinePlayers")};d.onmessage=function(a){if(void 0!==a){b._debug&&console.log(a.data);try{var c=jQuery.parseJSON(a.data);b._offlineInfoCallback&&b._offlineInfoCallback(c);if("SUCCESSFUL"==c.Status){$("#wssTotalOfflinePlayers").text(c.OfflinePlayers.length);var d=$(".wssMinecraftOfflineList");
0<d.length&&null==b._templateOfflinePlayerList&&(b._templateOfflinePlayerList=d.clone());b.mapToTemplate(b._templateOfflinePlayerList,d,c.OfflinePlayers,"playerInfoMapping");$(".wssMinecraftOfflineList").show()}}catch(f){console.log(f)}}};d.onerror=function(a){console.log("WebSocket Error "+a)}};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.getPluginInfo=function(a){a=a||{};void 0!==a.callback&&(this._pluginInfoCallback=a.callback);var d=new WebSocket(this._websocketAddress),b=this;d.onopen=function(){d.send("plugins")};d.onmessage=function(a){if(void 0!==a){b._debug&&console.log(a.data);try{var c=jQuery.parseJSON(a.data);b._pluginInfoCallback&&b._pluginInfoCallback(c);if("SUCCESSFUL"==c.Status){var d=$(".wssPluginList");0<d.length&&null==b._templatePluginList&&(b._templatePluginList=
d.clone());b.mapToTemplate(b._templatePluginList,d,c.Plugins,"pluginInfoMapping");$(".wssMinecraftPluginList").show()}}catch(f){console.log(f)}}};d.onerror=function(a){console.log("WebSocket Error "+a)}};
CaffeinatedRat.Minecraft.WebSocketServices.prototype.callService=function(a,d){d=d||{};var b=new WebSocket(this._websocketAddress),e=this;b.onopen=function(){b.send(a)};b.onmessage=function(a){if(void 0!==a){e._debug&&console.log(a.data);try{var b=jQuery.parseJSON(a.data);d.callback&&d.callback(b)}catch(f){console.log(f)}}};b.onerror=function(a){console.log("WebSocket Error "+a)}};
CaffeinatedRat.Minecraft.WebSocketServices.Exception=function(a,d){var b="CaffeinatedRat.Minecraft.WebSocketServices"+(void 0!==a?"."+a:""),b=b+(": "+d);this.toString=function(){return b}};CaffeinatedRat.Minecraft.WebSocketServices.NotSupportedException=function(a){CaffeinatedRat.Minecraft.WebSocketServices.Exception.call(this,a,"Websockets are not supported by this browser.")};
CaffeinatedRat.Minecraft.WebSocketServices.InvalidAddressException=function(a){CaffeinatedRat.Minecraft.WebSocketServices.Exception.call(this,a,"No WebSocket address has been provided.")};